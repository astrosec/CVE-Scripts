import subprocess
import re

def get_software_list() -> list:
    results = []

    with open('/var/lib/dpkg/status', 'r') as dpkg:
        package = ''
        version = ''

        for line in dpkg.readlines():
            if 'Package: ' in line:
                package = line.replace('Package: ', '').strip()

            if 'Version: ' in line:
                if len(package) == 0:
                    continue

                version = line.replace('Version: ', '').strip()

                results.append((package, version))
                package = version = ''

    """
    cmd = 'apt list --installed | tail -n +2'
    package_pattern = re.compile(r'^[a-zA-Z\-\.0-9+_~]+')
    version_pattern = re.compile(r' \d+[^\s]*\s')
    process_result = subprocess.run(cmd, shell=True, check=True, text=True, capture_output=True)
    results = parse_package_version(process_result.stdout.split('\n')[:-1], package_pattern, version_pattern)
    """

    cmd = 'snap list'
    process_result = subprocess.run(cmd, shell=True, text=True, capture_output=True)
    if process_result.returncode == 0:
        package_pattern = re.compile(r'^[a-zA-Z\-\.0-9+_~]+')
        version_pattern = re.compile(r' \d+[^\s]*')
        results.extend(parse_package_version(process_result.stdout.split('\n')[1:-1], package_pattern, version_pattern))

    cmd = 'flatpak list'
    process_result = subprocess.run(cmd, shell=True, text=True, capture_output=True)
    if process_result.returncode == 0:
        package_pattern = re.compile(r'[a-zA-Z\-0-9+_~]+\.[a-zA-Z\-\.0-9+_~]+')
        version_pattern = re.compile(r'\t\d+[^\s]*')
        parsed_packages = parse_package_version(process_result.stdout.split('\n')[1:-1], package_pattern, version_pattern)
        parsed_packages = [(entry[0].split('.')[-1], entry[1]) for entry in parsed_packages]
        results.extend(parsed_packages)

    return results

def get_supported_os() -> set:
    return {'Linux:debian', 'Linux:ubuntu', 'Linux:linuxmint', 'Linux:popos'}

def parse_package_version(process_results: list, package_pattern: re, version_pattern: re) -> list:
    parsed_results = []
    for line in process_results:
        if len(line) <= 1 or line == '\n':
            continue
        
        package_part = package_pattern.search(line)
        version_part = version_pattern.search(line)
        parsed_results.append((package_part.group().strip(), version_part.group().strip()))
    return parsed_results

def get_required_packages() -> set:
    return {}